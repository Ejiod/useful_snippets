import cx_Oracle
import pandas as pd
import pyarrow as pa
import pyarrow.parquet as pq

# Oracle connection parameters
dsn = cx_Oracle.makedsn('host', 'port', 'sid/service')
connection = cx_Oracle.connect('username', 'password', dsn)

# SQL query to execute
query = "SELECT * FROM your_table"

# Create a cursor and execute the query
cursor = connection.cursor()
cursor.execute(query)

# Reduce chunk size if needed
chunk_size = 1000000  # Adjust based on initial testing
file_number = 1

# Fetch and write chunks
while True:
    rows = cursor.fetchmany(chunk_size)
    if not rows:
        break
    df = pd.DataFrame(rows, columns=[col[0] for col in cursor.description])
    
    # Define file path
    file_path = f'data_chunk_{file_number}.parquet'
    
    # Convert DataFrame to Parquet
    table = pa.Table.from_pandas(df, preserve_index=False)
    pq.write_table(table, file_path, compression='snappy')
    
    print(f'Wrote {file_path}')
    file_number += 1

# Clean up
cursor.close()
connection.close()
